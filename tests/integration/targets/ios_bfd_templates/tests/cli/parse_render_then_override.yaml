---
- name: START ios_bfd_templates parse_render_override.yaml integration tests
  ansible.builtin.debug:
    msg: START ios_bfd_templates parse_render_override.yaml integration tests on connection={{ ansible_connection }}

- name: ios_bfd_templates parse, render and override configuration
  block:
    - name: Purge any existing BFD template configuration
      cisco.ios.ios_bfd_templates:
        state: purged

    - name: Create keychain for BFD authentication
      cisco.ios.ios_config:
        lines:
          - key 1
          - key-string bfd_test_key
        parents: key chain bfd_keychain

    - name: Parse the provided configuration
      cisco.ios.ios_bfd_templates:
        running_config: "{{ lookup('file', '_parsed.cfg') }}"
        state: parsed
      register: result_parsed

    - name: Render the provided configuration
      cisco.ios.ios_bfd_templates:
        config: "{{ result_parsed.parsed }}"
        state: rendered
      register: result_rendered

    - name: Override the provided configuration
      cisco.ios.ios_bfd_templates:
        config: "{{ result_parsed.parsed }}"
        state: overridden
      register: result_overridden

    - name: Override the provided configuration (IDEMPOTENT)
      cisco.ios.ios_bfd_templates:
        config: "{{ result_parsed.parsed }}"
        state: overridden
      register: result_overridden_idempotent

    - name: Purge any existing BFD template configuration again
      cisco.ios.ios_bfd_templates:
        state: purged
      register: result_purged

- name: Assets ios_bfd_templates parse, render and override configuration
  block:
    - name: Assert parsed, rendered, overridden and purged results
      ansible.builtin.assert:
        that:
          - result_parsed.parsed | length > 0
          - result_rendered.rendered | length > 0
          - result_overridden.changed == true
          - result_overridden_idempotent.changed == false
          - result_purged.changed == true

    - name: Assert parsed - verify against expected parsed output
      ansible.builtin.assert:
        that:
          - parsed == result_parsed['parsed']

    - name: Assert rendered - verify against expected rendered output
      ansible.builtin.assert:
        that:
          - result_rendered.rendered|symmetric_difference(rendered.commands) == []

    - name: Assert overridden - verify against expected execution output
      ansible.builtin.assert:
        that:
          - overridden['after'] == result_overridden['after']
          - overridden['commands']|symmetric_difference(result_overridden['commands']) == []

    - name: Cleanup keychain
      cisco.ios.ios_config:
        lines:
          - no key chain bfd_keychain
